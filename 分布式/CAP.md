## 架构设计中的权衡
一致性是分布式系统非常核心的特性。之所以说核心，是因为一致性会影响到其他很多特性，比如可用性、性能等。在分布式系统的架构设计中，需要在这些分布式特性之间选择一个平衡点，这种平衡被称为权衡（tradeoff）。
## CAP 的定义
CAP这三个字母分别代表了**Consistency（一致性）**、**Availability（可用性）**、**Partition-tolerance（分区容忍性）**，CAP定理总体上讲述了在分布式系统中，这三个属性不能同时获得。

具体来讲，在被证明的CAP定理中，这三个属性的定义分别是：
- 一致性：线性一致性（linearibility）。
- 可用性：对于分布式系统，如果这个系统持续地可用，那么所有non-failing（没有失败，也就是能工作）的节点，对于每个接收到的请求都必须产生一个响应。这个定义可以被理解为，在这个分布式系统中所使用的算法都必须最终（eventually）结束。
- 分区容忍性：**分区（partition）是指节点之间丢失任意数量的消息**。分区容忍是指能够容忍任意数量的消息丢失。

##  CAP 定理下的三种系统
既然不能同时获得一致性、可用性和分区容忍性这三个属性，那么就存在三种系统。
1. CP类型系统：也就是具有属性C和属性P的系统。这种系统在节点之间丢失消息的时候，可以达到线性一致性，但是不具有可用性。
2. AP类型系统：也就是具有属性A和属性P的系统。这种系统在节点之间丢失消息的时候，可以具有可用性，但是不具有线性一致性。
3.  CA类型系统：也就是具有属性C和属性A的系统。常见的单机数据库就是典型的CA类型系统。因为单机数据库是在单个节点上运行的，所以单机数据库满足一致性的要求。因为所有的请求都可以完成，所以其满足可用性的定义。

## 深入理解CAP定理中的P和A
### （1）属性P
在分布式系统中，是不可能做到不丢失消息的，所以网络分区一定是存在的。分区容忍是指当出现网络分区时，系统仍然能够保持其所具有的特性不变。例如，在CP类型系统中，当出现网络分区时，系统仍然能够保持一致性这个特性；而在AP类型系统中，当出现网络分区时，系统仍然能够保持可用性这个特性。也就是说，P不是一个独立存在的特性，它是伴随着其他特性一起存在的，不存在只具有P特性的系统。

然而，分布式系统必须面对丢失消息这个问题，所以这是分布式系统的必选项。对于单机数据库这样的单机系统，只有一个节点，所以不存在节点之间丢失消息，根本不存在网络分区，也就不存在容忍丢失消息，不存在容忍网络分区。

### （2）属性A
系统高可用是我们追求的目标，但是CAP定理中的可用性与我们追求的高可用是不一样的。为了清晰地区分，我们将CAP定理中的可用性称为CAP-Availability。

CAP-Availability既是一种非常严格的可用性，又是一种非常弱的可用性定义。**严格在于要求每个请求都必须有响应，只要有一个请求没有响应，就不满足可用性的定义**。本书也将CAP-Availability称为完全可用性。**同时CAP-Availability也是非常弱的定义，这个定义没有约束在多长时间内给出响应，只要最终给出响应就可以**。实际中，如果一个请求长时间没有响应，我们就认为服务是不可用的，虽然这个请求最终会给出响应。例如，一个系统中的所有请求都是在5分钟后给出正确的响应的，虽然这符合CAP定理中的可用性，但是实际中会认为这个系统是不可用的，因为用户不能容忍刷新一个页面要执行5分钟。

CAP-Availability与比较常见的主备模式系统中的高可用性（High Availability，HA）不一样。我们举例来说明这个差异。类似于单机数据库这样的单机系统具有CAP-Availability，也就是说，发送给这个系统的所有请求都会收到相应的响应。但是单机系统并不具有HA，当数据库节点宕机后，数据库服务将不可用。**HA一般是指通过副本方式形成一个主备系统，当出现节点宕机或者网络分区时，数据库服务仍然可用**。再举一个例子，一个ZooKeeper集群有三个节点，当leader与其他节点发生网络分区时，连接在leader上的客户端将不能再收到写请求的响应，所以不满足CAP-Availability。但是这时另外两个节点会发生选举，重新选出新的leader继续提供服务，所以ZooKeeper是一个具有HA的系统。同样，当某个follower发生网络分区时，发送给这个follower的写请求都会失败，不满足CAP-Availability的要求，但是这时发送给其他节点的请求仍然可以正确执行，所以服务整体是可用的。从定义和这两个例子中可以看到，CAP-Availability是不考虑节点宕机的，仅仅考虑非宕机节点是否能够保持可用性。

实际中，一般我们通过SLA（Service Level Agreement）来描述可用性，即使用可用时间来描述可用性，将其表述成一年之内不可用时长的百分比如99%、99.9%、99.99%这样的数字指标。比如，99%的意思就是一年当中有99%的时间是可用的，1%的时间是宕机的。按照一年实际的时间来算，这个百分比可以被换成小时或者分钟数。假如某个系统的可用性为99.99%，即一年中99.99%的时间系统都是可用的，0.01%的时间系统是不可用的，在这个不可用的时间里，所有的请求可能都没有响应，而实际中，“4个9”的系统是非常高可用的系统，但是并不满足CAP-Availability。


