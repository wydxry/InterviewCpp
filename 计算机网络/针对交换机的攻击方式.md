## 交换机的原理
工作在数据链路层的设备。它可以识别数据包中的MAC地址，但是无法识别出里面的IP地址。交换机中有一个包含了端口和硬件地址对应关系的CAM表，目前常见的攻击手段大都是针对CAM表的。

### MAC地址欺骗攻击
由于交换机中的CAM表是动态更新的，所以攻击者往往可以通过各种手段对其进行操纵。一个攻击者就可以通过向交换机发送伪造的数据帧，从而实现对CAM表的修改。

### MAC地址泛洪攻击
交换机有两种工作方式，正常情况下，交换机会通过CAM表对数据包进行转发，如果CAM表不能工作时，交换机则会将数据包从全部端口转发出去。因此黑客可以利用工具在短时间制造大量的数据帧发送给交换机，从而导致CAM表爆满，这样交换机就会退化成集线器。

MAC地址泛洪攻击是一种针对交换机的攻击方式，目的是监听同一局域网中用户的通信数据。前面已经介绍过交换机的工作核心：端口-MAC地址映射表。这张表中记录了交换机每个端口和与之相连的主机MAC地址之间的对应关系。通常情况下，交换机的每个端口只会连接一台主机，因而在CAM表中每个端口只会对应一个MAC地址。

如果在这种一一对应的情况下，交换机就无需担心MAC地址泛洪攻击的，因为一台交换机只有几十个端口，这样整个CAM表中最多也只有几十个项。但是由于现在的交换机都使用了级联技术，也就是A交换机可以连接到另一个B交换机的级联端口上。这样在B交换机的级联端口上就会对应多台主机的MAC地址，从而在CAM表中产生大量的记录。

但是交换机的缓存有限，因此它的CAM表中能保存的内容也是有限的。而且连接到交换机上的设备也可能经常会更换，所以交换机无需永远记住所有的端口与MAC地址的对应关系。所以CAM表采用了动态的更新方式，表中的每一个记录都被设定了一个自动老化时间，如果某个MAC地址在一定时间（例如300秒）不再出现，那么交换机将自动把该MAC地址从地址表中清除。当该MAC地址再次出现时，将会被当作新地址处理，从而使交换机可以维护一个精确而有用的CAM地址表。交换机档次越低，交换机的缓存也就越小，能够记住的 MAC 地址数也就越少。

MAC泛洪攻击就是由攻击者通过工具产生大量的数据帧，这些数据帧中的源MAC地址都是伪造的，而且并且不断变化。因而交换机将在攻击主机所连接的端口上产生大量的MAC地址表条目，从而在短时间内将交换机的CAM地址表填满，直到再无法接收新的条目。

此时对于网络中那些事先没有在交换机的 MAC 地址表中留下记录的主机，它们之间的数据通信就会全部采用广播的方式进行，这样虽然并不影响数据的发送和接收，但此时的交换机实质上就是一台集线器，攻击者在网络中的任何一台主机上打开 Wireshark，就可以监听到网络中的这些流量。

### 防御MAC地址泛洪攻击
虽然攻击者可以伪造出大量的数据包来攻击交换机，但是由于攻击者的数据包只能从交换机的某一个端口进入，所以我们可以限制每一个端口对应的MAC地址数量即可。

那么我们就可以在这个端口上进行设置，保证该端口最多可以学习8个mac地址，在交换机中进行配置的命令如下：
```shell
[Huawei-Ethernet0/0/3] port-security enable
[Huawei-Ethernet0/0/3] port-security mac-address sticky
[Huawei-Ethernet0/0/3] port-security protect-action protect
[Huawei-Ethernet0/0/3] port-security max-mac-num 8
```

虽然攻击者依然产生了大量的数据包，但是依然只占用了CAM表中的8项，因而永远无法达到填满整个CAM表的目的。


### STP操纵攻击
交换机中另外一个隐患来源于生成树协议。STP的原理是按照树的结构来构造网络拓扑，消除网络中的环路，避免由于环路的存在而造成广播风暴问题。STP允许冗余，但是同时确保每一时刻只有一条链路是运行的，并且没有回路出现。由于STP协议中各交换设备是通过交换BPDU报文信息传播生成树信息，而黑客就可以通过发送伪造的BPDU报文，控制交换设备的端口转发状态，从而动态地改变网络拓扑结构，并将所有的网络流量劫持到本机。

### 广播风暴攻击
由于以太网中的部分协议都是以广播形式工作的，例如地址解析协议（ARP）、动态主机配置协议（DHCP）等，因此交换机在正常情况下也需要对这些数据包进行广播。但是这些广播会占用主机资源和网络资源。

在遭受黑客攻击时，就会导致广播在网段内被大量复制，占用大量的网络资源，网络性能下降，甚至网络瘫痪，这就是广播风暴攻击。
